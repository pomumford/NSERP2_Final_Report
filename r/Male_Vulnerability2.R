#   Script Details                                                          ####

# Author: Peter Mumford

# Date:2022-06-27 

# Purpose: Evaluate factors that influence the vulnerability of male elk

###################################################################################
# Library / Functions / Data                                           ####

# Library                                                              ####
library(tidyverse) 
library(sf)
library(sp)
library(raster)
library(rgdal)
library(RODBC)
library(spatialEco)
library(here)
library(mapview)
library(lubridate)
library(survival)
library(hms)
library(adehabitatLT)
library(survminer)
library(GGally)

here()

# Functions                                                            ####

# Data                                                                 ####
mtstateplane <- "+proj=lcc +lat_1=49 +lat_2=45 +lat_0=44.25 +lon_0=-109.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"
latlong <- "+init=epsg:4326"

#load access tifs
Access.14 <- raster("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_1\\RSF_Preparation_and_Analysis\\output\\Access_14.tif")
Access.15 <- raster("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_1\\RSF_Preparation_and_Analysis\\output\\Access_15.tif")
Access.19 <- raster("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_1\\RSF_Preparation_and_Analysis\\output\\Access_19.tif")
Access.20 <- raster("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_1\\RSF_Preparation_and_Analysis\\output\\Access_20.tif")

# % tree cover
Cover.19 <-raster("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/GIS/RAP/%_Tree_Cover/RAP_2019_NW.tif")

#dist to all MR 
Dist.MR.all <- raster("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\DATA\\GIS\\MSDI\\Transportation_Network\\Dist_MR_all") 
#(MSDI and USFS hunting season MRs (C:\Users\pm132031\Documents\UM\SAPPHIRE_PROJECT\DATA\GIS\USFS\Sapphire_Roads_DeVoe\Archived\Sapphire_Roads_HuntSns)
#a lot of duplicated routes. Select features of MSDI roads layer in ArcMap based on location --> selected routes with 100m of USFS layers 
#manually unselected features in the MSDI layer that were selected, but should be kept in the layer
#deleted features that overlapped with layer created by Jesse DeVoe based on USFS motorized routes

#road shapefile for reference
MR.all <- shapefile("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\DATA\\GIS\\MSDI\\Transportation_Network\\ShapeFiles\\ALLRoadsMergedSapphireRoadsDeVoe.shp") 

#VRM
VRM <- raster("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/GIS/LANDFIRE/TIFF_files/VRM.tif")

####################################################################################


#####################################################################################
################################ STEPS ##############################################
#####################################################################################

# 1) Process raw location data from both phases
      #standardize columns in location data
      #filter to males during shooting light and fall hunting seasons
      #derive based on individual animal year
        #age
        #number of days monitored
        #fate
# 2) Link location data to mortality data from Phase 1 and 2
      #subsample (5/day) and limit to 1 hour before and after legal shooting light
      #cols: Animal.ID, Animal.ID.year, Date.capture, Date.off, Date.mortality, Fate, Date, Time, Hunt.season, Age., Mort.age, geometry (sf object) 
# 3) Derive GIS data and link to location data based on individual animal year
      #proportion of locations in cover >= 35% (value derived from chapter 2 that provides basic security to males during hunting seasons on accessible land)
      #proportion of locations on accessible land
      #average movement rate during rifle 
      #mean cover
      #mean med dist to MR
      #mean VRM
# 4) Derive summary stats via summarize()


#####################################################################################
################################# 2014-2016 #########################################
#####################################################################################

#
#PULL LOCATIONS FROM DATABASE AND CLEAN
#

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")

#get gps information
gps.dat1 <- sqlQuery(phase1.db, "SELECT * FROM LocationsAll")
gps.dat1 <- gps.dat1 %>% 
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Animal.ID = as.factor(Animal.ID)) %>% 
  filter(!(Animal.ID== "140070")) %>% # remove ind west of highway 93 not in sapphire pop, one additional male, but ranges on both sides of highway, at least for annual
  filter(!(Animal.ID== "140380")) %>% 
  filter(!(Animal.ID== "140650")) %>% 
  filter(!(Animal.ID== "141090")) %>% 
  filter(!(Animal.ID== "141580")) %>% #all locations during hunting seasons west of highway 93 
  filter(Sex == "Male") %>% 
  #set date and time format
  mutate(Date.time = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M", tz = "GMT")) %>% 
  dplyr::select(-c(FixStatus, Date, Time, DeviceID, DOP, DateTime, Sex, TempC, CaptureYr))

#
#GET OTHER ANIMAL INFO
#

#get mortality data
mort.dat1 <-sqlQuery(phase1.db, "SELECT * FROM MortalityInfo")
mort.dat1 <- mort.dat1 %>% 
  filter(Gender == "Male") %>% 
  rename(Animal.ID = 'Animal ID', 
         Date.capture = CaptureDate,
         Date.mortality = MortDate,
         Date.off = TransEndDate,
         Access = MortOwnrshp) %>% 
  mutate(Animal.ID = as.factor(Animal.ID),
         Date.mortality = as.POSIXct(Date.mortality, format = "%m/%d/%Y", tz = "GMT"))
head(mort.dat1)
#filter to harvest related morts, and standardize column names, and last clean
unique(mort.dat1$Cause1)
mort.dat1 <- mort.dat1 %>% 
  filter(Cause1 == "Harvest" | Cause1 == "Wounding loss") %>%
  #remove Animal ID 151500 because incidental recovery, date off before mortality date
  filter(!Animal.ID == "151500") %>% 
  filter(!(Animal.ID== "141580")) %>% #all locations during hunting seasons west of highway 93 
  mutate(Access = ifelse(Access == "Accessible", "Accessible", 
                         ifelse(Access == "Inaccessible", "Restricted", NA))) %>% 
  dplyr::select(Animal.ID, Date.capture, Date.off, Date.mortality, Access)

#get age  
animal.dat1 <- sqlQuery(phase1.db, "SELECT * FROM AnimalInfo")
animal.dat1 <- animal.dat1 %>%
  filter(Sex == "Male") %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Animal.ID = as.factor(Animal.ID)) %>% 
  dplyr::select(Animal.ID, Fate, Age)

#combine mortality and animal data
dat.1 <- left_join(mort.dat1, animal.dat1, by=c("Animal.ID" = "Animal.ID"))

#join gps dat and mort dat to get DateOff
gps.dat1 <- full_join(gps.dat1, dat.1, by=c("Animal.ID" = "Animal.ID")) 

#filter to range of locations and out incidental recoveries
length(unique(gps.dat1$Animal.ID))
gps.dat1 <- gps.dat1 %>% 
  group_by(Animal.ID) %>%
  filter(Date.time > Date.capture,
         Date.time < Date.off)
length(unique(gps.dat1$Animal.ID))
  #GOES FROM 28 TO 12
summary(gps.dat1)

#order alphabetically 
gps.dat1 <- gps.dat1[,order(colnames(gps.dat1))]


#####################################################################################
################################# 2018-2021 #########################################
#####################################################################################

#
#PULL LOCATIONS FROM DATABASE AND CLEAN
#

ns.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/NSERP2/NSERP2_FINAL_PM_Mortality_Update.accdb")

gps.dat2 <-sqlQuery(ns.db, "SELECT * FROM SapphireGPS")
gps.dat2 <- gps.dat2 %>% 
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID =AnimalID) %>% 
  mutate(Animal.ID=as.factor(Animal.ID),
         Time = format(as.POSIXct(Time), format("%H:%M:%S")),
         Date.time = (paste(Date, Time)), 
         Date.time = as.POSIXct(Date.time, format = "%Y-%m-%d %H:%M:%OS")) %>% 
  dplyr::select(Animal.ID, Date.time, Long, Lat) %>% 
  filter(!Animal.ID =="19584") #19584 dispersed to Rock Cr.
head(gps.dat2)

#animal data
animal.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_CaptureInfo")
animal.dat2 <- animal.dat2 %>%
  filter(Sex == "M") %>% 
  rename(Animal.ID = AnimalID, Date.capture = CaptureDate) %>% 
  dplyr::select(Animal.ID, Date.capture, Age, Sex) %>%
  mutate(Animal.ID=as.factor(Animal.ID))
head(animal.dat2)

#mortality data
mort.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_Survival_Updated")
#check unique causes of death and filter to harvest related
unique(mort.dat2$DeathCause)
unique(mort.dat2$Landowner)
#mutate
mort.dat2 <- mort.dat2 %>%
  rename(Animal.ID = AnimalID, Cause.of.death = DeathCause, Date.off = DateOff, Fate = AnimalFate, Access = Landowner, Date.mortality = DateofDeath) %>% 
  dplyr::select(Animal.ID, Cause.of.death, Date.off, Fate, Access, Date.mortality) %>%
  mutate(Animal.ID=as.factor(Animal.ID),
         Access = ifelse(Access != c("NA", "Private", "Unknown"), "Accessible",
                         ifelse(Access == "Private", "Restricted",
                                ifelse(Access == "Unknown", "Unknown", NA)))) %>% 
  mutate(across(Fate, replace, Fate == "Alive Off Air", "Live")) 

#bind animal and mort dat
dat.2 <- full_join(mort.dat2, animal.dat2, by = c("Animal.ID" = "Animal.ID")) %>% 
  filter(Sex == "M") %>% 
  filter(Cause.of.death == "Harvest" | Cause.of.death == "Wounding loss" | Cause.of.death == "Wounding Loss" | is.na(Cause.of.death)) %>%
  dplyr::select(-c(Cause.of.death))%>% 
  filter(!Animal.ID =="19584") %>%  #19584 dispersed to Rock Cr.
  mutate(Date.off = as.POSIXct(Date.off, format = "%Y-%m-%d", tz = "GMT"),
         Date.mortality = as.POSIXct(Date.mortality, format = "%Y-%m-%d", tz = "GMT"))

#check only monitoried mortalities of known-fate
yo <- full_join(mort.dat2, animal.dat2, by = c("Animal.ID" = "Animal.ID")) %>% 
  filter(Sex == "M") %>% 
  filter(!Animal.ID =="19584") %>%  #19584 dispersed to Rock Cr.
  mutate(Date.off = as.POSIXct(Date.off, format = "%Y-%m-%d", tz = "GMT"),
         Date.mortality = as.POSIXct(Date.mortality, format = "%Y-%m-%d", tz = "GMT")) %>% 
  filter(!Date.mortality > Date.off)

#link to gps data
gps.dat2<- full_join(gps.dat2, dat.2,  by = c("Animal.ID" = "Animal.ID")) %>% 
  filter(Sex == "M") %>% 
  dplyr::select(-c(Sex)) 
gps.dat2 <- gps.dat2[,order(colnames(gps.dat2))]

#filter to range of locations and out incidental recoveries
length(unique(gps.dat2$Animal.ID))
gps.dat2 <- gps.dat2 %>% 
  group_by(Animal.ID) %>% 
  filter(Date.time > Date.capture,
         Date.time < Date.off)
length(unique(gps.dat2$Animal.ID))
#GOES FROM 50 TO 42
head(gps.dat2)

#close databases
odbcCloseAll()

#
#CREATE DATAFRAME WITH ALL MORT INFO FOR SUMMARY STATISTICS
#

#standardize sex
dat.1$Sex <- "M"

#create dataframe with mortalities related to harvest
mort.dat.all.harvest <- rbind(dat.1, dat.2) %>% 
  filter(Sex == "M", Fate == "Dead") %>% 
  mutate(Year = year(Date.capture),
         Study.period = ifelse(Year == 2014 | Year == 2015, 1, 2),
         Month.day = format(Date.mortality,"%m-%d"),
         Hunt.season = ifelse(Month.day >= "09-04" & Month.day <= "10-20", "Archery",
                              ifelse(Month.day >= "10-23" & Month.day <= "12-02", "Rifle", "Other"))) %>% 
  group_by(Animal.ID) %>% 
  #take first because some animals captured more than once
  slice(1)

#write
saveRDS(mort.dat.all.harvest, file = "output\\Bull_Vulnerability\\Mortality_All_Harvest_Related.rds")

#####################################################################################
######### BIND AND CREATE COLUMNS FOR COXPH ANLYSIS #################################
#####################################################################################

gps.dat.all <- rbind(gps.dat1, gps.dat2) %>% 
  mutate(Year = year(Date.time),
         Date = as.Date(as.POSIXct(Date.time)),
         Animal.ID.year = as.factor(paste(Animal.ID, Year, sep = ".")),
         Time = format(as.POSIXct(Date.time), format("%H:%M")),
         #shooting light
         #filter to 1 hour before sunrise and after sunset Oct26, YYYY ,set for Florence, MT
         #filter to 1 hour before sunrise and after sunset Nov15, YYYY ,set for Florence, MT
         Shooting.light.archery = ifelse(Time >= "07:10" & Time <= "19:29",1,0),  
         Shooting.light.rifle = ifelse(Time >= "06:39" & Time <= "18:03",1,0),  
         #seasons to look at mortalities across seasons
         Archery = ifelse(Date.time >= "2014-09-06" & Date.time<= "2014-10-19",1,
                               ifelse(Date.time >= "2015-09-05" & Date.time<= "2015-10-18",1,
                                      ifelse(Date.time >= "2019-09-07" & Date.time<= "2019-10-20",1,
                                             ifelse(Date.time >= "2020-09-05" & Date.time<= "2020-10-18",1,
                                                    ifelse(Date.time >= "2021-09-04" & Date.time<= "2021-10-17",1,0))))),
         Rifle = ifelse(Date.time >= "2014-10-25" & Date.time<= "2014-11-30",1,
                              ifelse(Date.time >= "2015-10-24" & Date.time<= "2015-11-29",1,
                                     ifelse(Date.time >= "2019-10-26" & Date.time<= "2019-12-01",1,
                                            ifelse(Date.time >= "2020-10-24" & Date.time<= "2020-11-29",1,
                                                   ifelse(Date.time >= "2021-10-23" & Date.time<= "2021-11-28",1,0))))),
         Hunt.season = ifelse(Archery == 1,"Archery",
                              ifelse(Rifle == 1, "Rifle", NA)),
         Mort.age = as.numeric(difftime(Date.mortality, Date.capture, tz = "GMT", units = "days"))/365 + Age) 

#filter to shoot light and hunting seasons, sample 5 locations per day, get time monitored during hunting seasons
gps.dat.all <- gps.dat.all %>% 
  filter(Shooting.light.archery == 1 | Shooting.light.rifle == 1) %>% 
  filter(Rifle == 1 | Archery == 1) %>% 
  group_by(Animal.ID, Date) %>%
  distinct() %>% 
  #filter to only animal days with 5 or more locations per date
  filter(n() >= 5) %>% 
  sample_n(size = 5) %>% 
  ungroup()

#length of hunting season
as.numeric(difftime("2014-11-30", "2014-09-06",  tz = "GMT", units = "days")) #85, all equal with 5 days between archery and rifle

#get time monitored per animal ID year
length(unique(gps.dat.all$Animal.ID.year))
Time.monitored <- gps.dat.all %>% 
  group_by(Animal.ID.year, Date) %>% 
  #get one row per day
  slice(1) %>% 
  ungroup() %>% 
  group_by(Animal.ID.year) %>% 
  mutate(Days.monitored = n()) %>% 
  #get one row per animal ID year
  slice(1) %>% 
  ungroup() %>% 
  dplyr::select(Animal.ID.year, Days.monitored)
#rejoin
gps.dat.all <- left_join(gps.dat.all, Time.monitored, by = c("Animal.ID.year" = "Animal.ID.year"))           

#manually change fate to live for animals that eventually died but were alive at least one season
#check
yo <- gps.dat.all %>% 
  group_by(Animal.ID.year) %>% 
  slice(1) %>% 
  filter(Fate == "Dead") %>% 
  dplyr::select(Animal.ID, Animal.ID.year, Fate)
#change
gps.dat.all <- gps.dat.all %>% 
   mutate(Fate = ifelse(Animal.ID.year == "141520.2014" | Animal.ID.year == "141610.2014" | Animal.ID.year == "19540.2019" |Animal.ID.year == "19569.2019"| Animal.ID.year == "19715.2019"| Animal.ID.year == "19607.2020", "Live", Fate)) 
gps.dat.all <- gps.dat.all[,order(colnames(gps.dat.all))]

#
#CHANGE AGE FOR INDIVIDUALS THAT SURVIVED MORE THAN ONE YEAR, CREATE BINARY AGE CLASS (0 = <=4 years old, 1 = >4 years old)
#

test <- gps.dat.all %>% 
  group_by(Animal.ID) %>% 
  summarise(N.year = length(unique(Year))) %>% 
  ungroup() %>% 
  filter(N.year>1)
new.age <- gps.dat.all %>% 
  filter(Animal.ID %in% test$Animal.ID) %>% 
  group_by(Animal.ID, Year) %>% 
  slice(1) %>% 
  ungroup() %>% 
  group_by(Animal.ID) %>% 
  mutate(Age = ifelse(row_number() == 1, Age, Age + 1)) %>% 
  ungroup() %>% 
  dplyr::select(Animal.ID.year, Age)
#rebind and replace new ages for individuals that lived multiple years
gps.dat.all <- left_join(gps.dat.all, new.age, by = c("Animal.ID.year" = "Animal.ID.year")) %>% 
  dplyr::select(-c(Age.x)) %>% 
  rename(Age = Age.y) %>% 
  mutate(Age.class = ifelse(Age <= 4, 0, 1))
#check # of individuals with estimated age
length(unique(gps.dat.all$Animal.ID.year))
yo <- gps.dat.all %>% 
  group_by(Animal.ID.year) %>% 
  slice(1) %>% 
  filter(is.na(Age)) #12

#
#ENSURE REMOVAL OF INCIDENTAL RECOVERIES
#

#remove incidental recoveries
yo <- gps.dat.all %>% 
  filter(Fate == "Dead") %>% 
  group_by(Animal.ID.year) %>% 
  #ensure no incidental recoveries included
  filter(!Date.mortality > Date.off) %>% 
  ungroup() 
length(unique(yo$Animal.ID.year))
#filter to live
test <- gps.dat.all %>% 
  filter(Fate == "Live") 
length(unique(test$Animal.ID.year))

#bind  
gps.dat.all <-rbind(yo, test) 
length(unique(gps.dat.all$Animal.ID.year))

#
#CLEAN BEFORE TURN INTO SF DATAFRAME AND EXTRACT GIS DATA
#

gps.dat.all <- gps.dat.all %>% 
  dplyr::select(Access, Age, Animal.ID, Animal.ID.year, Date, Date.time, Days.monitored, Fate, Hunt.season, Long, Lat, Time)
saveRDS(gps.dat.all, file = "output\\Bull_Vulnerability\\GPS_Dat_All.rds")

#####################################################################################
######### CREATE SF DATAFRAME AND EXTRACT GIS DATA ##################################
#####################################################################################

gps.dat.all <- readRDS("output\\Bull_Vulnerability\\GPS_Dat_All.rds")

dat.sf <- gps.dat.all %>%
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform(crs = mtstateplane) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>%
  arrange(Animal.ID,Date.time)

#
#SET RASTER PROJECTION
#

######IMPORTANT#############
#use mtstateplane2 since has ellipsoid specified
#use method="ngb" for binary and method="bilinear" for continuous
#Access layers already formated = template for other rasters

#ensure right projections
Access.14 <-  projectRaster(Access.14, method='ngb', crs = mtstateplane) #ngb for catagorical 
Access.15 <-  projectRaster(Access.15, method='ngb', crs = mtstateplane) 
Access.19 <-  projectRaster(Access.19, method='ngb', crs = mtstateplane) 
Access.20 <-  projectRaster(Access.20, method='ngb', crs = mtstateplane) 
Dist.MR.all <- projectRaster(Dist.MR.all, method='bilinear',crs = mtstateplane)
Cover.19 <- projectRaster(Cover.19, method='bilinear',crs = mtstateplane) 
VRM <- projectRaster(VRM, method='bilinear',crs = mtstateplane) 

#extract values to elk locations
ext.access.14 <- raster::extract(Access.14, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Access.14=.)
ext.access.15 <- raster::extract(Access.15, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Access.15=.)
ext.access.19 <- raster::extract(Access.19, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Access.19=.)
ext.access.20 <- raster::extract(Access.20, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Access.20=.)
ext.DMR.all <- raster::extract(Dist.MR.all, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Dist.MR.all=.)
ext.cover.19 <- raster::extract(Cover.19, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,Cover.19=.)
ext.VRM <- raster::extract(VRM, dat.sf)%>%
  as.data.frame() %>%
  mutate(ID = row_number()) %>% 
  rename(.,VRM=.)

#join
dat.sf <- dat.sf %>% 
  ungroup() %>% #KEY
  mutate(ID = row_number()) %>% # create ID to join on (= ID in extractions)
  left_join(ext.access.14) %>% 
  left_join(ext.access.15) %>% 
  left_join(ext.access.19) %>% 
  left_join(ext.access.20) %>% 
  left_join(ext.DMR.all) %>% 
  left_join(ext.cover.19) %>% 
  left_join(ext.VRM) %>% 
  rename(Cover = Cover.19,
         Distance.MR = Dist.MR.all,
         Terrain.ruggedness = VRM) %>% 
  dplyr::select(-ID)
str(dat.sf)

#set access
dat.sf <- dat.sf %>% 
  mutate(Year = year(Date.time))
dat.sf <- dat.sf %>%
  rename(Mort.access = Access) %>% 
  mutate(Access = ifelse(dat.sf$Year == 2014, dat.sf$Access.14,
                             ifelse(dat.sf$Year == 2015, dat.sf$Access.15,
                                    ifelse(dat.sf$Year == 2019, dat.sf$Access.19,
                                           ifelse(dat.sf$Year == 2020, dat.sf$Access.20,
                                                  ifelse(dat.sf$Year == 2021, dat.sf$Access.20,
                                                  NA)))))) %>% 
  dplyr::select(-c(Access.14, Access.15, Access.19, Access.20))

#create column for proportion cover used over 35% (derived from chapter 2 threshold of security for males on accessible land during rifle) and access
dat.sf <- dat.sf %>% 
  mutate(Cover.35 = ifelse(Cover >= 35, 1, 0)) %>% 
  group_by(Animal.ID.year) %>% 
  filter(!is.na(Cover.35)) %>% 
  mutate(Prop.cover.35 = sum(Cover.35 == 1)/n(),
         Prop.access = sum(Access == 1)/n()) %>% 
  ungroup()

#
#MOVEMENT RATE (Jesse DeVoe's code)
#

#create date time column and arrange
yo.sf <- dat.sf %>% 
  arrange(Animal.ID.year, Date.time) %>% 
  distinct()

#look for duplicates
sum(duplicated(paste(yo.sf$Date.time, yo.sf$Animal.ID.year))) 
yo <- as.data.frame(duplicated(paste(yo.sf$Date.time, yo.sf$Animal.ID.year)))

#remove duplicates
yo.sf <- yo.sf %>% 
  group_by(Animal.ID.year) %>% 
  arrange(Date.time) %>%
  filter(duplicated(Date.time) == FALSE) %>% 
  ungroup() %>% 
  arrange(Animal.ID.year, Date.time)

#plot
mapview(yo.sf)

#check NAs
yo <- yo.sf %>% 
  dplyr::select(geometry, Date.time, Animal.ID.year) %>% 
  is.na()

#calculate trajectories by animal.id.year
yo.sp <- as_Spatial(yo.sf %>% st_transform(mtstateplane))
#had to make id as.character to work
traj <- adehabitatLT::as.ltraj(xy = coordinates(yo.sp), date = yo.sp$Date.time, id = as.character(yo.sp$Animal.ID.year))
traj.df <- do.call(rbind.data.frame, traj) %>%
  # get only dist (step length) and time difference, and turn to rate
  dplyr::select(dist, dt) %>%
  mutate(hrs = dt/3600, # Hours calc'd from dt (time interval in seconds, thus divided by 3600)
         rate = dist/hrs) # distance in meters per hour
head(traj.df)
#add column of average movement rate during rifle because risk highest during this season
yo.sf <- bind_cols(yo.sf, traj.df) 

#movement rates for rifle and archery season, even for those individuals alive only during archery
move.rates <- yo.sf %>%
  dplyr::select(Animal.ID.year, Hunt.season, dt, rate) %>% 
  st_set_geometry(NULL) %>% 
  na.omit() %>% #remove rows where rate = NA (only )
  arrange(Animal.ID.year) %>%
  group_by(Animal.ID.year) %>%
  mutate(Mean.movement.rate = mean(rate)) %>% 
  slice(1) %>% #make easier to view
  ungroup() %>% 
  dplyr::select(Animal.ID.year, Mean.movement.rate)

#join
yo.sf <- left_join(yo.sf, move.rates, by = "Animal.ID.year") 

#check dataframe
yo <-  yo.sf %>% 
  group_by(Animal.ID.year) %>% 
  slice(1)
  #27 mortalities
#
#CREATE DATA FOR COXPH MODEL
#

data.coxph <- yo.sf %>% 
  group_by(Animal.ID.year) %>%
  mutate(Mean.cover = mean(Cover),
         Med.distance.MR = median(Distance.MR),
         Mean.ruggedness = mean(Terrain.ruggedness)*100,
         Fate.bi = ifelse(Fate == "Live", 0, 1)) %>% 
  slice(1) %>%
  st_set_geometry(NULL) %>% 
  #not including age because biased sample
  dplyr::select(Animal.ID.year, Age, Days.monitored, Fate.bi, Prop.cover.35, Prop.access, Mean.movement.rate, Mean.cover, Med.distance.MR, Mean.ruggedness) %>% 
  ungroup() 

#write
saveRDS(data.coxph, file = "output\\Bull_Vulnerability\\Data_Coxph.rds")

#####################################################################################
######### COXPH MODELS AND GRAPHS ###################################################
#####################################################################################

#data
data.coxph <- readRDS("output\\Bull_Vulnerability\\Data_Coxph.rds")
#scale continuous covariates
data.coxph <- data.coxph %>% 
  #divide by 100 so unit is per 100m, not 1per m
  #scale ruggedness to can make inference about magnitude of effect based on standard deviations
  mutate(Mean.movement.rate100 = Mean.movement.rate/100,
         Med.distance.MR100 = Med.distance.MR/100,
         Mean.ruggedness.std = scale(Mean.ruggedness))

#check correlation of variables
ggcorr(as.data.frame(data.coxph), label = T, label_size = 2, layout.exp = 3) 
  #cover metrics and proportions access highly correlated, so remove cover

#remove cover
data.coxph <- data.coxph %>% 
  dplyr::select(-c(Prop.cover.35,Mean.cover))

#check correlation of variables again
ggcorr(as.data.frame(data.coxph), label = T, label_size = 2, layout.exp = 3) 

#get sd for covaraites
standard.deviations <- as.data.frame(apply(data.coxph,2,sd, simplify = FALSE))

#
#MODELS
#

#model with rifle rate
mod.rate.rifle <- coxph(Surv(Days.monitored, Fate.bi) ~ Prop.access + Mean.movement.rate.rifle + Med.distance.MR100 + Mean.ruggedness.std, data = data.coxph.rifle.move)
summary(mod.rate.rifle)
  #fails LRT***

#mod with just archery rate
mod.rate.archery <- coxph(Surv(Days.monitored, Fate.bi) ~ Prop.access + Mean.movement.rate.archery + Med.distance.MR100 + Mean.ruggedness.std, data = data.coxph.archery.move)
summary(mod.rate.archery)

#
#PLOTS
#

#forest plot
plot.forest <- ggforest(mod.rate.archery)
plot.forest +
  theme(text=element_text(size=12, family="Times New Roman"))
ggsave(filename = "Forest_plot.jpeg", path="output\\Bull_Vulnerability\\Figures")

#survival plots
fit <- survfit(mod.rate.archery)
summary(fit)
plot <- ggsurvplot(fit, data = data.coxph.archery.move,
           xlab = "Days Since Archery Start",
           xlim = c(0,90),
           break.time.by = 10,
           legend.labs = "Male elk"
           ) 
plot 
#df of season labels
df <- data.frame(x = c(1, 45, 50, 86), y = 0, labels = c("Start Archery","Start Hunting Break","Start Rifle ","End Hunting"), fam = "Times")
plot$plot + 
  geom_vline(xintercept = c(0, 44, 49, 85), linetype = "dashed") +
  annotate("text", x = df$x, y = df$y, label = df$labels, family = "Times", angle = 90, hjust = 0,vjust = 1) +
  theme(text=element_text(size=12, family="Times New Roman"))
ggsave(filename = "Survival_Plot.jpeg", path="output\\Bull_Vulnerability\\Figures")

