#   Script Details                                                          ####

# Author: Peter Mumford

# Date:2022-06-27 

# Purpose: Evaluate factors that influence the vulnerability of male elk

# load libraries                                                           
library(tidyverse) 
library(sf)
library(sp) #for kernel centroid estimate
library(raster)
library(rgdal)
library(RODBC)
library(spatialEco)
library(here)
library(mapview)
library(lubridate)
library(survival)
library(pb)

#set working drive
here()

#load projections
mtstateplane <- "+proj=lcc +lat_1=49 +lat_2=45 +lat_0=44.25 +lon_0=-109.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"
latlong <- "+init=epsg:4326"

#study area box
study.area.box <- shapefile("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_2\\output\\Study_Area\\Study_area_Box.shp") %>% 
  st_as_sf() %>% 
  st_transform(crs = latlong)


#####################################################################################
################################ STEPS ##############################################
#####################################################################################

# 1) Process raw location data from both phases
      #standardize columns in location data
        #Animal.ID, Date, Time, Hunt.season, geometry (sf object) 
      #filter to males during shooting light and fall hunting seasons
      #derive based on individual animal year
        #age
        #number of days monitored
        #fate
# 2) Link location data to mortality data from Phase 1 and 2
      #TO DO
        #subsample (###/day) and limit to 1 hour before and after legal shooting light
# 3) Derive GIS data and link to location data based on individual animal year
      #proportion of locations in cover >= 35% (value derived from chapter 2 that provides basic security to males during hunting seasons on accessible land)
      #proportion of locations on accessible land
      #average movement rate during rifle 
      #mean cover
      #mean med dist to MR
      #mean VRM
      #mean distance to accessible land?
# 4) Derive summary stats via summarize()


#####################################################################################
################################# 2014-2016 #########################################
#####################################################################################

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")

#
#PULL NSERP LOCATIONS FROM DATABASE AND CLEAN
#

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")

#get gps information
gps.dat1 <- sqlQuery(phase1.db, "SELECT * FROM LocationsAll")
gps.dat1 <- gps.dat1 %>% 
  #rename_all(list(~gsub("\\.*", "", .))) %>% # get rid of dots in name
  #rename(Date=DateTimeLocal, Lat=Latitude, Long=Longitude) %>%
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID =AnimalID)%>% 
  mutate(Animal.ID=as.factor(Animal.ID)) %>% 
  filter(!(Animal.ID== "140070")) %>% # remove ind west of highway 93 not in sapphire pop, one additional male, but ranges on both sides of highway, at least for annual
  filter(!(Animal.ID== "140380")) %>% 
  filter(!(Animal.ID== "140650")) %>% 
  filter(!(Animal.ID== "141090")) %>% 
  filter(Sex == "Male") %>% 
  #set date and time format
  mutate(Date = format(as.POSIXct(Date), format = "%Y-%m-%d", tz = "GMT"),
         Time = format(as.POSIXct(DateTime), format = "%H:%M")) %>% 
  dplyr::select(-c(FixStatus, DeviceID, DOP, DateTime, Sex, TempC, CaptureYr))

#
#GET OTHER ANIMAL INFO
#

#get mortality data
mort.dat1 <-sqlQuery(phase1.db, "SELECT * FROM MortalityInfo")
mort.dat1 <- mort.dat1 %>% 
  filter(Gender == "Male") %>% 
  rename(Animal.ID =`Animal ID`)%>% 
  dplyr::select(Animal.ID, MortDate, TransEndDate, Cause1, Cause2, MortOwnrshp, HarvestSeason) %>%
  mutate(Animal.ID = as.factor(Animal.ID)) %>%
  mutate(Date.mortality = as.Date(MortDate, format="%m/%d/%Y")) %>% 
  mutate(Date.off = as.Date(TransEndDate, format="%m/%d/%Y"))
head(mort.dat1)

#filter to harvest related morts, and standardize column names, and last clean
unique(mort.dat1$Cause1)
mort.dat1 <- mort.dat1 %>% 
  filter(Cause1 == "Harvest" | Cause1 == "Wounding loss") %>%
  rename(Harvest.season = HarvestSeason,
         Access = MortOwnrshp) %>% 
  mutate(Access = ifelse(Access == "Accessible", "Accessible", "Restricted" )) %>% 
  dplyr::select(Animal.ID, Date.off, Date.mortality, Access, Harvest.season)

#get age  
animal.dat1 <- sqlQuery(phase1.db, "SELECT * FROM AnimalInfo")
animal.dat1 <- animal.dat1 %>%
  filter(Sex == "Male") %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Date.capture = as.Date(Date, format = "%m/%d/%Y"),
         Animal.ID = as.factor(Animal.ID)) %>% 
  dplyr::select(Animal.ID, Date.capture, Age)

#combine mortality and animal data
dat.1 <- left_join(mort.dat1, animal.dat1, by=c("Animal.ID" = "Animal.ID"))

#get age at mort
dat.1 <- dat.1 %>% 
  mutate(Mort.age = as.numeric(difftime(Date.mortality, Date.capture, tz = "GMT", units = "days"))) %>% 
  mutate(Mort.age = Mort.age/365 + Age,
         Fate = "Dead") 

#join gps dat and mort dat to get DateOff
gps.dat1 <- full_join(gps.dat1, dat.1, by=c("Animal.ID" = "Animal.ID")) 

#lubridate so just date and not empty times
gps.dat1$Date.capture <- ymd(gps.dat1$Date.capture) %>% 
  with_tz(tzone = "GMT")
gps.dat1$Date.mortality <- ymd(gps.dat1$Date.mortality) %>% 
  with_tz(tzone = "GMT")

#Filter each animals gps data to the start and end date 
#check n animal ID
length(unique(gps.dat1$Animal.ID))
gps.dat1 <- gps.dat1 %>% 
  group_by(Animal.ID) %>%
  filter(Date > Date.capture,
         Date < Date.off)
length(unique(gps.dat1$Animal.ID))
  #GOES FROM 28 TO 13
summary(gps.dat1)

#clean before make sf dataframe

#create sf dataframe
gps.sf1 <- gps.dat1 %>% 
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform(mtstateplane) %>% #  project it to the MT state plane
  ungroup() %>% 
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>% 
  arrange(Animal.ID, Date, Time) #order rows by values of a column low to high
str(gps.sf1)

# Write .rds file
write_rds(gps.sf1, "\\output\\Bull_Vulnerability\\data_sf1.rds")

# # Write shapefile 
# st_write(gps_sf1, dsn="C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP1", layer="ns1_gps_data.shp", driver="ESRI Shapefile", update=T, delete_layer=T)
# 
# #load data and filter to males
# nserp1.dat <- readRDS("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP1/ns1_gps_data.rds")


#####################################################################################
################################# 2018-2021 #########################################
#####################################################################################

#Read in updated GPS datafile and clean it up
#datafile in the format that comes straight from the Lotek Webservice
#PROCESSING ALL DATA BECAUSE HAD ADDITIONAL MORTALITIES BEYOND RANGE OF CHAPTER 2 DATA

# Update animal info from dbase stored on shared drive
ns.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/NSERP2/NSERP2_FINAL.accdb")

gps.dat2 <-sqlQuery(ns.db, "SELECT * FROM SapphireGPS")
gps.dat2 <- gps.dat2 %>% 
  #rename_all(list(~gsub("\\.*", "", .))) %>% # get rid of dots in name
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID =AnimalID)%>% 
  mutate(Animal.ID=as.factor(Animal.ID)) %>% 
  dplyr::select(-c(DeviceID, DT, DOP, Altitude, Sats, Herd))
head(gps.dat2)

#animal data
animal.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_CaptureInfo")
animal.dat2 <- animal.dat2 %>%
  rename(Animal.ID = AnimalID, Date.capture = CaptureDate) %>% 
  dplyr::select(Animal.ID, Date.capture, Age, Sex) %>%
  mutate(Animal.ID=as.factor(Animal.ID))
head(animal.dat2)

#collar data
mort.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_Survival")
unique(mort.dat2$DeathCause)
mort.dat2 <- mort.dat2 %>%
  rename(Animal.ID = AnimalID, Date.off = DateOff, Fate = AnimalFate, Access = Landowner, Date.mortality = DateofDeath) %>% 
  filter(DeathCause == "Harvest" | DeathCause == "Wounding loss" | DeathCause == "Wounding Loss") %>% 
  filter(Fate == "Dead") %>% 
  dplyr::select(Animal.ID, Date.off, Fate, Access, Date.mortality) %>%
  mutate(Animal.ID=as.factor(Animal.ID),
         Access = ifelse(Access != c("NA", "Private"), "Accessible",
                         ifelse(Access == "Private", "Restricted", NA)))

#bind animal and mort dat

#Link collar info to GPS data and clean it up
gps.dat2 <- left_join(gps.dat2, collar.dat2, by=c("DeviceID" = "CollarID")) %>%
  
  #Make date/time format correct
  #original when file taken directly from Lotek, above file was manipulated slightly prior to prcessing: mutate(Date=as.POSIXct(Date*(60*60*24), origin="1899-12-30", tz="GMT")
  #tz="MST" would subtract 7 hours, GMT keeps it as is, which is already corrected
  mutate(Date=as.POSIXct(Date, origin="1899-12-30", tz="GMT"),
         Time=format(Date, "%H:%M:%S"),
         Date=as.Date(Date, tz="GMT")) %>%
  
  #remove low accuracy locations and those outside of study area if collars deployed elsewhere (based on study area box)
  filter(DOP < 10) %>%
  filter(Lat > 46.2449 & Lat < 46.87038 ) %>%
  filter(Long < -113.5163 & Long > -114.2225 ) %>%
  mutate(AnimalID=as.factor(AnimalID)) %>%
  # retain desired fields
  dplyr::select(AnimalID, Date, Time, Long, Lat, DateDeployed, DateOff)

#Add sex from animal info table
gps.dat2 <- left_join(gps.dat2, animal.dat2, by=c("AnimalID" = "AnimalID")) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex, Long, Lat, DateDeployed, DateOff)

# Filter each animals gps data to the start and end date
gps.dat2 <- gps.dat2  %>%
  # Filter the GPS data for each animal to start the day after capture and end the day before the mortality.
  group_by(AnimalID) %>%
  filter(Date > DateDeployed,
         Date < DateOff) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex, Long, Lat, DateDeployed)
head(gps.dat2)

#Inspect and filter out any bad locations manually with lines of code here

#attach mort dat to gps dat
gps.dat2 <- left_join(gps.dat2, mort.dat2, by=c("AnimalID" = "AnimalID")) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex.x, Long, Lat, MortLong, MortLat, MortCause, MortConfidence, Ownership, DateDeployed, EstMortDate) %>% 
  rename(Sex = Sex.x)

#add age at death by finding difference between EstMortDate and DateDeployed, and adding to Age
gps.dat2 <- gps.dat2 %>% 
  mutate(Mort.age = as.numeric(difftime(EstMortDate, DateDeployed, tz = "GMT", units = "days"))) %>% 
  mutate(Mort.age = Mort.age/365 + Age) 


#
#CHECK MORT LOCATIONS MAKE SENSE AND FILTER ACCORDINGLY
#


#
#CREATE SF DATAFRAME AND ADD HUNTING DATA
#

gps_sf2 <- gps.dat2 %>%
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform(crs = mtstateplane) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
  mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # create DateTime for creating lines
  ungroup() %>%
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>%
  arrange(AnimalID, Date, Time)
# #if want to make mort location the sf coords
# gps_sf2 <- gps.dat2 %>%
#   st_as_sf(coords = c("MortLong", "MortLat"), remove=F, crs = 4326) %>% # wgs84
#   st_transform(crs = mtstateplane2) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
#   mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # create DateTime for creating lines
#   ungroup() %>%
#   mutate(UTME.mort = st_coordinates(.)[,1], # add UTMS
#          UTMN.mort = st_coordinates(.)[,2]) %>%
#   arrange(AnimalID, Date, Time)

gps_sf2 <- gps_sf2 %>% 
  mutate(Year = as.numeric(format(Date, format = "%Y")),
         Time = format(as.POSIXct(DateTime), format("%H:%M")),
         Shooting.light.archery = ifelse(Time >= "07:10:00" & Time <= "19:29:00",1,0),
         Shooting.light.rifle = ifelse(Time >= "06:39:00" & Time <= "18:03:00",1,0),
         Archery = ifelse(Date >= "2019-09-07" & Date <= "2019-10-20",1,
                          ifelse(Date >= "2020-09-05" & Date <= "2020-10-18",1,0)),
         Rifle = ifelse(Date >= "2019-10-26" & Date <= "2019-12-01",1,
                        ifelse(Date >= "2020-10-24" & Date <= "2020-11-29",1,0)),
         Hunt.Season = ifelse(Archery == 1, "Archery",
                              ifelse(Rifle == 1, "Rifle", NA))) 
gps_sf2 <- gps_sf2 %>% 
  rename(Animal.ID = AnimalID,
         Mort.long = MortLong,
         Mort.lat = MortLat,
         Mort.cause = MortCause,
         Mort.confidence = MortConfidence, 
         Date.deployed = DateDeployed,
         Access = Ownership,
         Mort.date = EstMortDate) %>% 
  mutate(Access = ifelse(Access == "Public", "Accessible",
                         ifelse(Access == "Private  " | Access == "Unknown", "Restricted", NA))) %>% 
  filter(Sex=="Male")

#arrange alphabetically
male.dat2 <- gps_sf2[,order(colnames(gps_sf2))]





#write
write_rds(gps_sf2, ".rds")
st_write(gps_sf2, dsn="", layer=".shp", driver="ESRI Shapefile", update=T, delete_layer=T)




#
#COMBINE NSERP AND NSERP2 DATA, ADD HUNTING SEASON COLUMNS, CLEAN, AND WRITE
#

# Define seasons ####
#  - Winter: Dec 1 - Mar 31
#  - Spring: Apr 1 - Jun 30
#  - Summer: Jul 1 - Aug 31
#  - Fall: Sep 1 - Nov 30
gps_sf1 <- gps_sf1 %>%
  mutate(Month.Day=format(as.Date(Date), "%m%d"),
         Season=ifelse(Month.Day >= "1201" | Month.Day <= "0331", "WINTER",
                       ifelse(Month.Day >= "0401" & Month.Day <= "0630", "SPRING",
                              ifelse(Month.Day >= "0701" & Month.Day <= "0831", "SUMMER",
                                     ifelse(Month.Day >= "0901" & Month.Day <= "1130", "FALL",  
                                            NA))))) %>%
  dplyr::select(-Month.Day) %>% #remove field
  mutate(Hunt.Season=ifelse(DateTime >= "2014-09-06" & DateTime<= "2014-10-19","Archery",
                            ifelse(DateTime >= "2015-09-05" & DateTime<= "2015-10-18","Archery",
                                   ifelse(DateTime >= "2014-10-25" & DateTime <= "2014-11-30", "Rifle",
                                          ifelse(DateTime >= "2015-10-24" & DateTime <= "2015-11-29", "Rifle",
                                                 NA)))))                      


# mutate(Year = as.numeric(format(Date, format = "%Y")),
#        Time = format(as.POSIXct(DateTime), format("%H:%M")),
#        Shooting.light.archery = ifelse(Time >= "07:10:00" & Time <= "19:29:00",1,0),
#        Shooting.light.rifle = ifelse(Time >= "06:39:00" & Time <= "18:03:00",1,0),
#        Archery = ifelse(Date >= "2019-09-07" & Date <= "2019-10-20",1,
#                         ifelse(Date >= "2020-09-05" & Date <= "2020-10-18",1,0)),
#        Rifle = ifelse(Date >= "2019-10-26" & Date <= "2019-12-01",1,
#                       ifelse(Date >= "2020-10-24" & Date <= "2020-11-29",1,0)),
#        Hunt.Season = ifelse(Archery == 1, "Archery",
#                             ifelse(Rifle == 1, "Rifle", NA)))




#
#INTERSECT WITH ACCESS TO CHECK N OF LOCATIONS ON ACCESSIBLE AND RESTRICTED LAND
#







#get N
tmp <- data %>% 
  st_set_geometry(NULL) %>% 
  filter(Used == 1) %>% 
  group_by(Dataset, Year) %>% 
  summarise(N.locs = n(),
            N.ind = length(unique(Animal.ID)))
#write
write.csv(tmp, file = "C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Other\\NSERP2_Final_Report\\output\\Bull_Vulnerability\\Miscellaneous\\Bull_Vulnerability_N.csv", row.names = FALSE, append = TRUE)



