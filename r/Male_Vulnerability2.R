#   Script Details                                                          ####

# Author: Peter Mumford

# Date:2022-06-27 

# Purpose: Evaluate factors that influence the vulnerability of male elk

# load libraries                                                           
library(tidyverse) 
library(sf)
library(sp) #for kernel centroid estimate
library(raster)
library(rgdal)
library(RODBC)
library(spatialEco)
library(here)
library(mapview)
library(lubridate)
library(survival)
library(hms)
library(pb)

#set working drive
here()

#load projections
mtstateplane <- "+proj=lcc +lat_1=49 +lat_2=45 +lat_0=44.25 +lon_0=-109.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"
latlong <- "+init=epsg:4326"

#study area box
study.area.box <- shapefile("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_2\\output\\Study_Area\\Study_area_Box.shp") %>% 
  st_as_sf() %>% 
  st_transform(crs = latlong)


#####################################################################################
################################ STEPS ##############################################
#####################################################################################

# 1) Process raw location data from both phases
      #standardize columns in location data
        #Animal.ID, Date, Time, Hunt.season, geometry (sf object) 
      #filter to males during shooting light and fall hunting seasons
      #derive based on individual animal year
        #age
        #number of days monitored
        #fate
# 2) Link location data to mortality data from Phase 1 and 2
      #TO DO
        #subsample (###/day) and limit to 1 hour before and after legal shooting light
# 3) Derive GIS data and link to location data based on individual animal year
      #proportion of locations in cover >= 35% (value derived from chapter 2 that provides basic security to males during hunting seasons on accessible land)
      #proportion of locations on accessible land
      #average movement rate during rifle 
      #mean cover
      #mean med dist to MR
      #mean VRM
      #mean distance to accessible land?
# 4) Derive summary stats via summarize()


#####################################################################################
################################# 2014-2016 #########################################
#####################################################################################

#
#PULL NSERP LOCATIONS FROM DATABASE AND CLEAN
#

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")

#get gps information
gps.dat1 <- sqlQuery(phase1.db, "SELECT * FROM LocationsAll")
gps.dat1 <- gps.dat1 %>% 
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Animal.ID = as.factor(Animal.ID)) %>% 
  filter(!(Animal.ID== "140070")) %>% # remove ind west of highway 93 not in sapphire pop, one additional male, but ranges on both sides of highway, at least for annual
  filter(!(Animal.ID== "140380")) %>% 
  filter(!(Animal.ID== "140650")) %>% 
  filter(!(Animal.ID== "141090")) %>% 
  filter(Sex == "Male") %>% 
  #set date and time format
  mutate(Date.time = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M", tz = "GMT")) %>% 
  dplyr::select(-c(FixStatus, Date, Time, DeviceID, DOP, DateTime, Sex, TempC, CaptureYr))

#
#GET OTHER ANIMAL INFO
#

#get mortality data
mort.dat1 <-sqlQuery(phase1.db, "SELECT * FROM MortalityInfo")
mort.dat1 <- mort.dat1 %>% 
  filter(Gender == "Male") %>% 
  rename(Animal.ID = 'Animal ID', 
         Date.capture = CaptureDate,
         Date.mortality = MortDate,
         Date.off = TransEndDate,
         Access = MortOwnrshp) %>% 
  mutate(Animal.ID = as.factor(Animal.ID),
         Date.mortality = as.POSIXct(Date.mortality, format = "%m/%d/%Y", tz = "GMT"))
head(mort.dat1)
#filter to harvest related morts, and standardize column names, and last clean
unique(mort.dat1$Cause1)
mort.dat1 <- mort.dat1 %>% 
  filter(Cause1 == "Harvest" | Cause1 == "Wounding loss") %>%
  #remove Animal ID 151500 because incidental recovery, date off before mortality date
  filter(!Animal.ID == "151500") %>% 
  mutate(Access = ifelse(Access == "Accessible", "Accessible", 
                         ifelse(Access == "Inaccessible", "Restricted", NA))) %>% 
  dplyr::select(Animal.ID, Date.capture, Date.off, Date.mortality, Access)

#get age  
animal.dat1 <- sqlQuery(phase1.db, "SELECT * FROM AnimalInfo")
animal.dat1 <- animal.dat1 %>%
  filter(Sex == "Male") %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Animal.ID = as.factor(Animal.ID)) %>% 
  dplyr::select(Animal.ID, Fate, Age)

#combine mortality and animal data
dat.1 <- left_join(mort.dat1, animal.dat1, by=c("Animal.ID" = "Animal.ID"))

#join gps dat and mort dat to get DateOff
gps.dat1 <- full_join(gps.dat1, dat.1, by=c("Animal.ID" = "Animal.ID")) 

#Filter each animals gps data to the start and end date 
#check n animal ID
length(unique(gps.dat1$Animal.ID))
gps.dat1 <- gps.dat1 %>% 
  group_by(Animal.ID) %>%
  filter(Date.time > Date.capture,
         Date.time < Date.off)
length(unique(gps.dat1$Animal.ID))
  #GOES FROM 28 TO 12
summary(gps.dat1)

#order alphabetically 
gps.dat1 <- gps.dat1[,order(colnames(gps.dat1))]


#####################################################################################
################################# 2018-2021 #########################################
#####################################################################################

#Read in updated GPS datafile and clean it up
#datafile in the format that comes straight from the Lotek Webservice

#gps data
ns.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/NSERP2/NSERP2_FINAL.accdb")

gps.dat2 <-sqlQuery(ns.db, "SELECT * FROM SapphireGPS")
gps.dat2 <- gps.dat2 %>% 
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  rename(Animal.ID =AnimalID,
         Date.time = DT)%>% 
  mutate(Animal.ID=as.factor(Animal.ID)) %>% 
  dplyr::select(Animal.ID, Date.time, Long, Lat)
head(gps.dat2)

#animal data
animal.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_CaptureInfo")
animal.dat2 <- animal.dat2 %>%
  filter(Sex == "M") %>% 
  rename(Animal.ID = AnimalID, Date.capture = CaptureDate) %>% 
  dplyr::select(Animal.ID, Date.capture, Age, Sex) %>%
  mutate(Animal.ID=as.factor(Animal.ID))
head(animal.dat2)

#mortality data
mort.dat2 <- sqlQuery(ns.db, "SELECT * FROM Sapphire2_Survival")
#check unique causes of death and filter to harvest related
unique(mort.dat2$DeathCause)
mort.dat2 <- mort.dat2 %>%
  rename(Animal.ID = AnimalID, Cause.of.death = DeathCause, Date.off = DateOff, Fate = AnimalFate, Access = Landowner, Date.mortality = DateofDeath) %>% 
  dplyr::select(Animal.ID, Cause.of.death, Date.off, Fate, Access, Date.mortality) %>%
  mutate(Animal.ID=as.factor(Animal.ID),
         Access = ifelse(Access != c("NA", "Private"), "Accessible",
                         ifelse(Access == "Private", "Restricted", NA))) %>% 
  mutate(across(Fate, replace, Fate == "Alive Off Air", "Live")) 

#bind animal and mort dat
dat.2 <- full_join(mort.dat2, animal.dat2, by = c("Animal.ID" = "Animal.ID")) %>% 
  filter(Sex == "M") %>% 
  filter(Cause.of.death == "Harvest" | Cause.of.death == "Wounding loss" | Cause.of.death == "Wounding Loss" | is.na(Cause.of.death)) %>%
  dplyr::select(-c(Cause.of.death))
  
#link to gps data
gps.dat2<- full_join(gps.dat2, dat.2,  by = c("Animal.ID" = "Animal.ID")) %>% 
  filter(Sex == "M") %>% 
  dplyr::select(-c(Sex)) 
gps.dat2 <- gps.dat2[,order(colnames(gps.dat2))]

length(unique(gps.dat2$Animal.ID))
gps.dat2 <- gps.dat2 %>% 
  group_by(Animal.ID) %>%
  filter(Date.time > Date.capture,
         Date.time < Date.off)
length(unique(gps.dat2$Animal.ID))
#GOES FROM 51 TO 43
head(gps.dat2)

#
#CREATE DATAFRAME WITH ALL MORT INFO FOR SUMMARY STATISTICS
#

dat.1$Sex <- "M"
mort.dat.all <- rbind(dat.1, dat.2) %>% 
  filter(Sex == "M", Fate == "Dead") %>% 
  mutate(Year = year(Date.capture),
         Study.period = ifelse(Year == 2014 | Year == 2015, 1, 2),
         Month.day = format(Date.mortality,"%m-%d"),
         Hunt.season = ifelse(Month.day >= "09-04" & Month.day <= "10-20", "Archery",
                              ifelse(Month.day >= "10-23" & Month.day <= "12-02", "Rifle", "Other"))) %>% 
  group_by(Animal.ID) %>% 
  #take first because some animals captured more than once
  slice(1)
        
        
#write
saveRDS(mort.dat.all, file = "output\\Bull_Vulnerability\\Mortality_all.rds")

#####################################################################################
######### BIND AND CREATE COLUMNS FOR COXPH ANLYSIS #################################
#####################################################################################

gps.dat.all <- rbind(gps.dat1, gps.dat2) %>% 
  mutate(Year = year(Date.time),
         Date = as.Date(as.POSIXct(Date.time)),
         Animal.ID.year = as.factor(paste(Animal.ID, Year, sep = ".")),
         Time = format(as.POSIXct(Date.time), format("%H:%M")),
         #shooting light
         #filter to 1 hour before sunrise and after sunset Oct26, YYYY ,set for Florence, MT
         #filter to 1 hour before sunrise and after sunset Nov15, YYYY ,set for Florence, MT
         Shooting.light.archery = ifelse(Time >= "07:10" & Time <= "19:29",1,0),  
         Shooting.light.rifle = ifelse(Time >= "06:39" & Time <= "18:03",1,0),  
         #seasons to look at mortalities across seasons
         Archery = ifelse(Date.time >= "2014-09-06" & Date.time<= "2014-10-19",1,
                               ifelse(Date.time >= "2015-09-05" & Date.time<= "2015-10-18",1,
                                      ifelse(Date.time >= "2019-09-07" & Date.time<= "2019-10-20",1,
                                             ifelse(Date.time >= "2020-09-05" & Date.time<= "2020-10-18",1,
                                                    ifelse(Date.time >= "2021-09-04" & Date.time<= "2021-10-17",1,0))))),
         Rifle = ifelse(Date.time >= "2014-10-25" & Date.time<= "2014-11-30",1,
                              ifelse(Date.time >= "2015-10-24" & Date.time<= "2015-11-29",1,
                                     ifelse(Date.time >= "2019-10-26" & Date.time<= "2019-12-01",1,
                                            ifelse(Date.time >= "2020-10-24" & Date.time<= "2020-11-29",1,
                                                   ifelse(Date.time >= "2021-10-23" & Date.time<= "2021-11-28",1,0))))),
         Hunt.season = ifelse(Archery == 1,"Archery",
                              ifelse(Rifle == 1, "Rifle", NA)),
         Mort.age = as.numeric(difftime(Date.mortality, Date.capture, tz = "GMT", units = "days"))/365 + Age) 

#filter to shoot light and hunting seasons, sample 5 locations per day, get time monitored during hunting seasons
#filter out Animal ID 20278, because malfuncitoning time on collar, sub sample, then add back in
yo <- gps.dat.all %>% 
  filter(Animal.ID == "20278") %>% 
  filter(Rifle == 1 | Archery == 1) %>% 
  group_by(Date) %>%
  sample_n(size = 5) %>% 
  ungroup()
#subsample main dataframe
gps.dat.all <- gps.dat.all %>% 
  filter(!Animal.ID == "20278") %>% 
  filter(Shooting.light.archery == 1 | Shooting.light.rifle == 1) %>% 
  filter(Rifle == 1 | Archery == 1) %>% 
  group_by(Animal.ID, Date) %>%
  #filter to only animal days with 5 or more locations
  filter(n() >= 5) %>% 
  distinct() %>%
  sample_n(size = 5) %>% 
  ungroup()
#rebind
gps.dat.all <- rbind(gps.dat.all, yo) %>% 
  distinct()

#length of hunting season
as.numeric(difftime("2014-11-30", "2014-09-06",  tz = "GMT", units = "days")) #85

#get time monitored per animal ID year
length(unique(gps.dat.all$Animal.ID.year))
Time.monitored <- gps.dat.all %>% 
  group_by(Animal.ID.year, Date) %>% 
  #get one row per day
  slice(1) %>% 
  ungroup() %>% 
  group_by(Animal.ID.year) %>% 
  mutate(Days.monitored = n()) %>% 
  #get one row per animal ID year
  slice(1) %>% 
  ungroup() %>% 
  dplyr::select(Animal.ID.year, Days.monitored)
#rejoin
gps.dat.all <- left_join(gps.dat.all, Time.monitored, by = c("Animal.ID.year" = "Animal.ID.year"))           

#manually change fate to live for animals that eventually died but were alive at least one season
#check
yo <- gps.dat.all %>% 
  group_by(Animal.ID.year) %>% 
  slice(1) %>% 
  filter(Fate == "Dead") %>% 
  dplyr::select(Animal.ID, Animal.ID.year, Fate)
#change
gps.dat.all <- gps.dat.all %>% 
   mutate(Fate = ifelse(Animal.ID.year == "141520.2014" | Animal.ID.year == "141610.2014" | Animal.ID.year == "19607.2020", "Live", Fate)) 
gps.dat.all <- gps.dat.all[,order(colnames(gps.dat.all))]

#change age for individuals that survived more than one year

#
#CREATE SF DATAFRAME AND EXTRACT GIS DATA
#

           
          
           










#
#CREATE SF DATAFRAME AND ADD HUNTING DATA
#

gps_sf2 <- gps.dat2 %>%
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform(crs = mtstateplane) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
  mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # create DateTime for creating lines
  ungroup() %>%
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>%
  arrange(AnimalID, Date, Time)



#
#INTERSECT WITH ACCESS TO CHECK N OF LOCATIONS ON ACCESSIBLE AND RESTRICTED LAND
#







#get N
tmp <- data %>% 
  st_set_geometry(NULL) %>% 
  filter(Used == 1) %>% 
  group_by(Dataset, Year) %>% 
  summarise(N.locs = n(),
            N.ind = length(unique(Animal.ID)))
#write
write.csv(tmp, file = "C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Other\\NSERP2_Final_Report\\output\\Bull_Vulnerability\\Miscellaneous\\Bull_Vulnerability_N.csv", row.names = FALSE, append = TRUE)



