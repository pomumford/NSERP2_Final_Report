#   Script Details                                                          ####

# Author: Peter Mumford

# Date:2022-05-18 

# Purpose: Evaluate factors that influence the vulnerability of male elk

# load libraries                                                           
library(tidyverse) 
library(sf)
library(sp) #for kernel centroid estimate
library(raster)
library(rgdal)
library(RODBC)
library(spatialEco)
library(here)
library(mapview)
library(lubridate)
library(survival)

#set working drive
here()
#setwd("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_2")


#eg dataset from standfor heart translplant study
#t5 score is value of mismatch for patient and donor
#time is likely time since transplant
heart.df <- stanford2

#load projections
mtstateplane <- "+proj=lcc +lat_1=49 +lat_2=45 +lat_0=44.25 +lon_0=-109.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +no_defs +towgs84=0,0,0"
latlong <- "+init=epsg:4326"

#study area box
study.area.box <- shapefile("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_2\\output\\Study_Area\\Study_area_Box.shp") %>% 
  st_as_sf() %>% 
  st_transform(crs = latlong)

#full dataset
#not including additional data after 2020, but will provide general idea of N
data <- readRDS("output\\Data_Final_FemaleRSF_NO_distMR_Cover") %>% 
  rename(Female.RSF=Prob.Female)

#subset
data.archery.accessible <- data %>% 
  filter(Dataset=="Archery.Accessible")
data.archery.inaccessible <- data %>% 
  filter(Dataset=="Archery.Inaccessible")

data.rifle.accessible <- data %>% 
  filter(Dataset=="Rifle.Accessible")
data.rifle.inaccessible <- data %>% 
  filter(Dataset=="Rifle.Inaccessible")

snippet 
#####################################################################################
################### CHECK N ACROSS ACCESS ###########################################
#####################################################################################

#get N
tmp <- data %>% 
  st_set_geometry(NULL) %>% 
  filter(Used == 1) %>% 
  group_by(Dataset, Year) %>% 
  summarise(N.locs = n(),
            N.ind = length(unique(Animal.ID)))
#write
write.csv(tmp, file = "C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Other\\NSERP2_Final_Report\\output\\Bull_Vulnerability\\Miscellaneous\\Bull_Vulnerability_N.csv", row.names = FALSE, append = TRUE)

snippet 
#####################################################################################
############### PROCESS GPS LOCATIONS FROM NSERP AND NSERP2 #########################
#####################################################################################

#
#2014-2016 ####
#

#This section will process the GPS data and write a cleaned .rds file of all the gps point and line data.
#Read in updated GPS datafile and clean it up ####
# Datafile in the format that comes straight from the Lotek Webservice

#
#PULL NSERP LOCATIONS FROM DATABASE AND CLEAN
#

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")

#get gps information
gps.dat1 <- sqlQuery(phase1.db, "SELECT * FROM LocationsAll") #CHECK PROCESSED VS RAW
gps.dat1 <- gps.dat1 %>% 
  #rename_all(list(~gsub("\\.*", "", .))) %>% # get rid of dots in name
  #rename(Date=DateTimeLocal, Lat=Latitude, Long=Longitude) %>%
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10) %>% 
  mutate(AnimalID=as.factor(AnimalID)) %>% 
  filter(!(AnimalID== "140070")) %>% # remove ind west of highway 93 not in sapphire pop, one additional male, but ranges on both sides of highway, at least for annual
  filter(!(AnimalID== "140380")) %>% 
  filter(!(AnimalID== "140650")) %>% 
  filter(!(AnimalID== "141090"))

#get animal information
animal.dat1 <- sqlQuery(phase1.db, "SELECT * FROM AnimalInfo")
animal.dat1 <- animal.dat1 %>%
  rename(CaptureDate=Date) %>%
  dplyr::select(AnimalID, CaptureDate, DeviceID, CaptureArea=Location, Sex) %>% 
  mutate(AnimalID=as.factor(AnimalID)) %>% 
  mutate(CaptureDate=as.Date(CaptureDate, format="%m/%d/%Y")) %>%
  mutate(DateDeployed=as.Date(CaptureDate, format="%m/%d/%Y")) %>% #add date deployed
  filter(!(AnimalID== "140070")) %>% # remove ind west of highway 93 not in sapphire pop
  filter(!(AnimalID== "140380")) %>% 
  filter(!(AnimalID== "140650")) %>% 
  filter(!(AnimalID== "141090")) 
  filter(!(AnimalID== "141580")) #majority of points W of highway 93, alpine bull!

#check filters, crs originally in wgs84
st_as_sf(gps.dat1, coords = c("Long", "Lat"), crs = 4326) %>% 
  st_transform(crs = mtstateplane2) %>%          
  filter(AnimalID =="141580") %>% 
  mapview()

head(animal.dat1)

#animal.dat1$Sex <-ifelse(animal.dat1$Sex == "M", "Male",
#ifelse(animal.dat1$Sex == "F", "Female", NA))

collar.dat1 <- sqlQuery(phase1.db, "SELECT * FROM SapphireCollars")
collar.dat1 <- collar.dat1 %>%
  rename(CollarID="ID & SN")

mort.dat1 <-sqlQuery(phase1.db, "SELECT * FROM MortalityInfo")
mort.dat1 <- mort.dat1 %>% 
  rename(AnimalID=`Animal ID`) %>% 
  dplyr::select(AnimalID, MortDate, TransEndDate, Cause1, Cause2, MortOwnrshp, HarvestSeason) %>%
  mutate(AnimalID=as.factor(AnimalID)) %>%
  mutate(DateMortality=as.Date(MortDate, format="%m/%d/%Y")) %>% 
  mutate(DateOff=as.Date(TransEndDate, format="%m/%d/%Y"))%>% 
  rename(MortLat = Lat,
         MortLong = Long)head(mort.dat1)
mort.dat1$Sex <-ifelse(mort.dat1$Sex == "M", "Male",
                       ifelse(mort.dat1$Sex == "F", "Female", NA))
odbcCloseAll()

#
#join table to compile necessary columns
#

# gps.dat1 <- left_join(gps.dat1, collar.dat1, by=c("DeviceID" = "CollarID")) %>% 
#   # Make date/time format correct
#   
#   mutate(Date=as.POSIXct(Date*(60*60*24), origin="1899-12-30", tz="GMT"), #tz="MST" would subtract 7 hours, GMT keeps it as is, which is already corrected
#          Time=format(Date, "%H:%M:%S"),
#          Date=as.Date(Date, tz="GMT")) %>% 
#          mutate(AnimalID=as.factor(AnimalID)) %>% 
#   # retain desired fields
#   dplyr::select(AnimalID, Date, Time, Long, Lat, DateDeployed, DateOff)

#Add sex from animal info table
gps.dat1 <- left_join(gps.dat1, animal.dat1, by=c("AnimalID" = "AnimalID"))  

gps.dat1 <- gps.dat1 %>% 
  dplyr::select(AnimalID, Date, Time, DateTime, Sex.x, Long, Lat, DateDeployed.y) %>% 
  rename(Sex=Sex.x) %>% 
  rename(DateDeployed=DateDeployed.y)

#join gps dat and mort dat to get DateOff
gps.dat1 <- left_join(gps.dat1, mort.dat1, by=c("AnimalID" = "AnimalID")) 


#lubridate format
gps.dat1$DateTime <- ymd_hms(gps.dat1$DateTime) %>% 
  with_tz(tzone = "GMT")

gps.dat1$Date <- ymd(gps.dat1$Date) %>% 
  with_tz(tzone = "GMT")

#lubridate so just date and not empty times
gps.dat1$DateDeployed <- ymd(gps.dat1$DateDeployed) %>% 
  with_tz(tzone = "GMT")

gps.dat1$DateOff <- ymd(gps.dat1$DateOff) %>% 
  with_tz(tzone = "GMT")

#Filter each animals gps data to the start and end date 
gps.dat1 <- gps.dat1 %>% 
  group_by(AnimalID) %>%
  filter(Date > DateDeployed,
         Date < DateOff) %>%
  dplyr::select(AnimalID, Date, Time, DateTime, Sex, Long, Lat)
head(gps.dat1)

#create a spatial data frame using the sf package
gps_sf1 <- gps.dat1 %>% 
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform("+init=EPSG:32100") %>% #MT state plane
  #st_transform(mtstateplane) %>% #  project it to the MT state plane
  #mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # already did with lubridate above
  ungroup() %>% 
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>% 
  arrange(AnimalID, DateTime) #order rows by values of a column low to high

# Define seasons ####
#  - Winter: Dec 1 - Mar 31
#  - Spring: Apr 1 - Jun 30
#  - Summer: Jul 1 - Aug 31
#  - Fall: Sep 1 - Nov 30
gps_sf1 <- gps_sf1 %>%
  mutate(Month.Day=format(as.Date(Date), "%m%d"),
         Season=ifelse(Month.Day >= "1201" | Month.Day <= "0331", "WINTER",
                       ifelse(Month.Day >= "0401" & Month.Day <= "0630", "SPRING",
                              ifelse(Month.Day >= "0701" & Month.Day <= "0831", "SUMMER",
                                     ifelse(Month.Day >= "0901" & Month.Day <= "1130", "FALL",  
                                            NA))))) %>%
  dplyr::select(-Month.Day) %>% #remove field
  mutate(Hunt.Season=ifelse(DateTime >= "2014-09-06" & DateTime<= "2014-10-19","Archery",
                            ifelse(DateTime >= "2015-09-05" & DateTime<= "2015-10-18","Archery",
                                   ifelse(DateTime >= "2014-10-25" & DateTime <= "2014-11-30", "Rifle",
                                          ifelse(DateTime >= "2015-10-24" & DateTime <= "2015-11-29", "Rifle",
                                                 NA)))))                      

str(gps_sf1)

# Write gps data
# Write .rds file
write_rds(gps_sf1, "C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP1/ns1_gps_data.rds")

# Write shapefile 
st_write(gps_sf1, dsn="C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP1", layer="ns1_gps_data.shp", driver="ESRI Shapefile", update=T, delete_layer=T)

#load data and filter to males ####
nserp1.dat <- readRDS("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP1/ns1_gps_data.rds")


#
#2018-2021 ####
#

#Read in updated GPS datafile and clean it up
#datafile in the format that comes straight from the Lotek Webservice
#PROCESSING ALL DATA BECAUSE HAD ADDITIONAL MORTALITIES BEYOND RANGE OF CHAPTER 2 DATA

# Update animal info from dbase stored on shared drive
ns.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/NSERP2/NSERP2.accdb")

#load data ####
gps.dat2 <- read.csv("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\DATA\\Telemetry\\GPS_122121_ALL_NSERP2.CSV", head=T); head(gps.dat2)

gps.dat2 <- gps.dat2 %>%
  rename_all(list(~gsub("\\.*", "", .))) %>% # get rid of dots in name
  rename(Date=DateTimeLocal, Lat=Latitude, Long=Longitude) %>%
  filter(Lat > 46) %>% filter(Long < -112) %>% filter(Long > -114.3) %>%   #Get rid bad fixes
  filter(DOP < 10)
head(gps.dat2)

#animal data
animal.dat2 <- sqlQuery(ns.db, "SELECT * FROM AnimalInfo")
animal.dat2 <- animal.dat2 %>%
  dplyr::select(AnimalID, EstAge, ToothAge, CaptureDate, CollarID, Location=CaptureArea, Sex) %>%
  mutate(AnimalID=as.factor(AnimalID)) %>%
  mutate(CaptureDate=as.Date(CaptureDate, format="%m/%d/%Y"))
head(animal.dat2)

animal.dat2$Sex <-ifelse(animal.dat2$Sex == "M", "Male",
                         ifelse(animal.dat2$Sex == "F", "Female", NA))

#use estimated age if no tooth age
animal.dat2 <- animal.dat2 %>% 
  mutate(Age = ifelse(!is.na(ToothAge), ToothAge, EstAge))

#collar data
collar.dat2 <- sqlQuery(ns.db, "SELECT * FROM CollarInfo")
collar.dat2 <- collar.dat2 %>%
  dplyr::select(AnimalID, CollarID, DateDeployed, DateOff) %>%
  mutate(AnimalID=as.factor(AnimalID)) %>%
  mutate(CaptureDate=as.Date(DateDeployed, format="%m/%d/%Y")) %>%
  mutate(CaptureDate=as.Date(DateOff, format="%m/%d/%Y"))
head(collar.dat2)

#mortality data
mort.dat2 <-sqlQuery(ns.db, "SELECT * FROM Mortalities")
mort.dat2 <- mort.dat2 %>% 
  mutate(AnimalID=as.factor(AnimalID)) %>% 
  dplyr::select(AnimalID,  CollarID, Sex, EstMortDate, MortCause, MortConfidence, Ownership, Lat, Long, Notes) %>% #no snow depth since NSERP didn't record
  mutate(AnimalID=as.factor(AnimalID)) %>%
  mutate(DateMortality=as.Date(EstMortDate, format="%m/%d/%Y")) %>% 
  rename(MortLat = Lat,
         MortLong = Long)
mort.dat2$Sex <-ifelse(mort.dat2$Sex == "M", "Male",
                         ifelse(mort.dat2$Sex == "F", "Female", NA))

head(mort.dat2)
odbcCloseAll()

#Link collar info to GPS data and clean it up
gps.dat2 <- left_join(gps.dat2, collar.dat2, by=c("DeviceID" = "CollarID")) %>%
  
  #Make date/time format correct
  #original when file taken directly from Lotek, above file was manipulated slightly prior to prcessing: mutate(Date=as.POSIXct(Date*(60*60*24), origin="1899-12-30", tz="GMT")
  #tz="MST" would subtract 7 hours, GMT keeps it as is, which is already corrected
  mutate(Date=as.POSIXct(Date, origin="1899-12-30", tz="GMT"),
          Time=format(Date, "%H:%M:%S"),
         Date=as.Date(Date, tz="GMT")) %>%

  #remove low accuracy locations and those outside of study area if collars deployed elsewhere (based on study area box)
  filter(DOP < 10) %>%
  filter(Lat > 46.2449 & Lat < 46.87038 ) %>%
  filter(Long < -113.5163 & Long > -114.2225 ) %>%
  mutate(AnimalID=as.factor(AnimalID)) %>%
  # retain desired fields
  dplyr::select(AnimalID, Date, Time, Long, Lat, DateDeployed, DateOff)

#Add sex from animal info table
gps.dat2 <- left_join(gps.dat2, animal.dat2, by=c("AnimalID" = "AnimalID")) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex, Long, Lat, DateDeployed, DateOff)

# Filter each animals gps data to the start and end date
gps.dat2 <- gps.dat2  %>%
  # Filter the GPS data for each animal to start the day after capture and end the day before the mortality.
  group_by(AnimalID) %>%
  filter(Date > DateDeployed,
         Date < DateOff) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex, Long, Lat, DateDeployed)
head(gps.dat2)

#Inspect and filter out any bad locations manually with lines of code here

#attach mort dat to gps dat
gps.dat2 <- left_join(gps.dat2, mort.dat2, by=c("AnimalID" = "AnimalID")) %>%
  dplyr::select(AnimalID, Age, Date, Time, Sex.x, Long, Lat, MortLong, MortLat, MortCause, MortConfidence, Ownership, DateDeployed, EstMortDate) %>% 
  rename(Sex = Sex.x)

#add age at death by finding difference between EstMortDate and DateDeployed, and adding to Age
gps.dat2 <- gps.dat2 %>% 
  mutate(Mort.age = as.numeric(difftime(EstMortDate, DateDeployed, tz = "GMT", units = "days"))) %>% 
  mutate(Mort.age = Mort.age/365 + Age) 


#
#CHECK MORT LOCATIONS MAKE SENSE AND FILTER ACCORDINGLY
#


#
#CREATE SF DATAFRAME AND ADD HUNTING DATA
#

gps_sf2 <- gps.dat2 %>%
  st_as_sf(coords = c("Long", "Lat"), remove=F, crs = 4326) %>% # wgs84
  st_transform(crs = mtstateplane) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
  mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # create DateTime for creating lines
  ungroup() %>%
  mutate(UTME = st_coordinates(.)[,1], # add UTMS
         UTMN = st_coordinates(.)[,2]) %>%
  arrange(AnimalID, Date, Time)
# #if want to make mort location the sf coords
# gps_sf2 <- gps.dat2 %>%
#   st_as_sf(coords = c("MortLong", "MortLat"), remove=F, crs = 4326) %>% # wgs84
#   st_transform(crs = mtstateplane2) %>% # ensure in MT state lane - may not be necessary depending on what projection your data already is in
#   mutate(DateTime=as.POSIXct(paste(Date, Time, sep=" "), tz="GMT")) %>% # create DateTime for creating lines
#   ungroup() %>%
#   mutate(UTME.mort = st_coordinates(.)[,1], # add UTMS
#          UTMN.mort = st_coordinates(.)[,2]) %>%
#   arrange(AnimalID, Date, Time)

gps_sf2 <- gps_sf2 %>% 
  mutate(Year = as.numeric(format(Date, format = "%Y")),
         Time = format(as.POSIXct(DateTime), format("%H:%M")),
         Shooting.light.archery = ifelse(Time >= "07:10:00" & Time <= "19:29:00",1,0),
         Shooting.light.rifle = ifelse(Time >= "06:39:00" & Time <= "18:03:00",1,0),
         Archery = ifelse(Date >= "2019-09-07" & Date <= "2019-10-20",1,
                          ifelse(Date >= "2020-09-05" & Date <= "2020-10-18",1,0)),
         Rifle = ifelse(Date >= "2019-10-26" & Date <= "2019-12-01",1,
                          ifelse(Date >= "2020-10-24" & Date <= "2020-11-29",1,0)),
         Hunt.Season = ifelse(Archery == 1, "Archery",
                                     ifelse(Rifle == 1, "Rifle", NA))) 
gps_sf2 <- gps_sf2 %>% 
  rename(Animal.ID = AnimalID,
         Mort.long = MortLong,
         Mort.lat = MortLat,
         Mort.cause = MortCause,
         Mort.confidence = MortConfidence,
         Date.deployed = DateDeployed,
         Access = Ownership,
         Mort.date = EstMortDate) %>% 
  mutate(Access = ifelse(Access == "Public", "Accessible",
                         ifelse(Access == "Private" | Access == "Unknown", "Restricted", NA))) %>% 
  filter(Sex=="Male")

#arrange alphabetically
male.dat2 <- gps_sf2[,order(colnames(gps_sf2))]

################################# LEFT OFF ON PHASE 2 DAT, FINISH PHASE 1 ###########################################

#write
write_rds(gps_sf2, ".rds")
st_write(gps_sf2, dsn="", layer=".shp", driver="ESRI Shapefile", update=T, delete_layer=T)

# 
# #examine then filter out erroneous points
# #load csv of erroneous points, format to match gps_sf2
# bad.pts <- read.csv("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP2_ALL_Outliers.csv", head=T)
# 
# gps_sf2 <- gps_sf2 %>%
#   filter(!ID %in% bad.pts$ID) %>%
#   dplyr::select(-ID) %>%
#   st_set_geometry(NULL)

# #load data derived above ####
# male.dat <- read.csv("C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/Reporting/NSERP2_GPS_Data_ALL_MALE.csv")



#
#COMBINE NSERP AND NSERP2 DATA, ADD HUNTING SEASON COLUMNS, CLEAN, AND WRITE
#


# mutate(Year = as.numeric(format(Date, format = "%Y")),
#        Time = format(as.POSIXct(DateTime), format("%H:%M")),
#        Shooting.light.archery = ifelse(Time >= "07:10:00" & Time <= "19:29:00",1,0),
#        Shooting.light.rifle = ifelse(Time >= "06:39:00" & Time <= "18:03:00",1,0),
#        Archery = ifelse(Date >= "2019-09-07" & Date <= "2019-10-20",1,
#                         ifelse(Date >= "2020-09-05" & Date <= "2020-10-18",1,0)),
#        Rifle = ifelse(Date >= "2019-10-26" & Date <= "2019-12-01",1,
#                       ifelse(Date >= "2020-10-24" & Date <= "2020-11-29",1,0)),
#        Hunt.Season = ifelse(Archery == 1, "Archery",
#                             ifelse(Rifle == 1, "Rifle", NA)))




#
#INTERSECT WITH ACCESS TO CHECK N OF LOCATIONS ON ACCESSIBLE AND RESTRICTED LAND
#




