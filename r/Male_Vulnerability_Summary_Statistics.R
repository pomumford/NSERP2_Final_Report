# Script Details                                                       ####

# Author: Peter Mumford

# Date:2022-07-01 

# Purpose: Summary statistics for bull vulnerability analysis

###############################################################################
# Library / Functions / Data                                           ####

# Library                                                              ####
library(tidyverse) 
library(sf)
library(here)
library(mapview)
library(lubridate)
library(hms)
library(broom)
here()

# Functions                                                            ####

# Data                                                                 ####
mort.dat.all <- readRDS("output\\Bull_Vulnerability\\Mortality_all.rds")
data.no.age <- readRDS("output\\Bull_Vulnerability\\Data_Coxph_No_Age.rds")
#load coxph data from Male_Vulnerability2 script
###############################################################################

#
#LIVE VS DEAD
#

live.vs.dead <- data.coxph %>% 
  group_by(Fate.bi) %>% 
  summarize(N = n(),
            Age = mean(Age, na.rm = TRUE),
            Days.monitored = mean(Days.monitored),
            Prop.access = mean(Prop.access),
            Movement.rate = mean(Mean.movement.rate),
            Distance.MR = mean(Med.distance.MR),
            Terrain.ruggedness = mean(Mean.ruggedness),
            Cover = mean(Mean.cover),
            Prop.cover35 = mean(Prop.cover.35)) %>% 
  ungroup() %>% 
  apply(2, round, digits = 2) %>% 
  as.data.frame()
write.csv(live.vs.dead, file = "output\\Bull_Vulnerability\\Tables\\Live_Vs_Dead_Stats.csv")

#two sided t test
t.test.live.dead <- data.coxph %>% 
  dplyr::select(-c(Animal.ID.year, Days.monitored)) %>% 
  relocate(Fate.bi, .before = Age) %>% 
  as.data.frame()
t.test.live.dead <- lapply(t.test.live.dead[-1], function(x) t.test(x ~ t.test.live.dead$Fate.bi)) 
t.test.live.dead.df <- do.call(rbind, lapply(t.test.live.dead, tidy)) %>% 
  rownames_to_column() %>% 
  as.data.frame() %>% 
  rename(var = rowname,
         diff = estimate,
         mean.live = estimate1,
         mean.dead = estimate2,
         ) %>% 
  dplyr::select(var, diff, mean.live, mean.dead, p.value, conf.low, conf.high, row.names(TRUE))
write.csv(t.test.live.dead.df, file = "output\\Bull_Vulnerability\\Tables\\T_Test_Live_Dead_DF.csv")


#
#MORTALITIES BY SEASON AND ACCESS
#

#not including incidental recoveries
morts.monitored <- mort.dat.all %>% 
  filter(!Date.mortality > Date.off) %>% 
  group_by(Access, Hunt.season, Study.period) %>% 
  summarise(N = n())

#statistics for chapter 2 (2014-2015 and 2019-2020) not including incidental recoveries
#total mortalities for chapter 2 2019-2020 are under dat.2 in Male_Vulnerability2 script with filter of Cause.of.death off
morts.known.fate.chapter2 <- dat.2 %>% 
  filter(!Fate == "Euthanized" & !Fate == "Live" 
         & Date.off >= Date.mortality
         & !Cause.of.death == "Unknown") %>% 
  #remove duplicated Animal.ID
  group_by(Animal.ID) %>% 
  slice(1) %>% 
  ungroup()
saveRDS(morts.known.fate.chapter2, file = "output\\Bull_Vulnerability\\Morts_Known_Fate_Chapter2.rds")

morts.monitored.chapter2 <- mort.dat.all %>% 
  #remove incidental recoveries
  filter(!Date.mortality > Date.off) %>% 
  #limit to Chapter 2 study period
  filter(Year == 2014 | 2015 | 2019 | 2020) %>% 
  group_by(Access, Hunt.season, Study.period) %>% 
  summarise(N = n())

#including incidental recoveries
morts.all <- mort.dat.all %>% 
  group_by(Access, Hunt.season, Study.period) %>% 
  summarise(N = n())

