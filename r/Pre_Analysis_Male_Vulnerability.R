# Script Details                                                       ####

# Author: Peter Mumford

# Date:2022-06-09 

# Purpose: Derive summary stats for males that lived and died, clarify covariates to use in CoxPH analysis of factors that influence vulnerability of males to harvest

###############################################################################
# Library / Functions / Data                                           ####

# Library                                                              ####

library(tidyverse) 
library(sf)
library(sp) #for kernel centroid estimate
library(raster)
library(rgdal)
library(RODBC)
library(spatialEco)
library(here)
library(mapview)
library(lubridate)
library(survival)
library(adehabitatLT)

#set working drive
here()

# Functions                                                            ####

# Data                                                                 ####

#data of 5 male locations per day from 1 hour before to 1 hour after legal shooting light
data <- readRDS("C:\\Users\\pm132031\\Documents\\UM\\SAPPHIRE_PROJECT\\ANALYSES\\Spatial\\R\\CHAPTER_2\\output\\Data_Final_FemaleRSF_NO_distMR_Cover") %>% 
  filter(Used==1) %>% 
  dplyr::select(Animal.ID, Dataset, Cover, Date, Dist.MR, Season, Time, geometry, VRM) %>% 
  separate(Dataset, c('Hunt.season', 'Access')) %>% 
  mutate(Access = replace(Access, Access == "Inaccessible", "Restricted"))  #keep syntax consistent
  
###############################################################################

#
#STEPS
#

# 1) Load location data from chapter 2 (during legal hunting hours and hunting seasons)
# 2) Link to mort data from phase 1 and 2
# 3) Derive GIS data and link to location data
      #proportion of locations in cover >= 35% (value derived from chapter 2 that provides basic security to males during hunting seasons on accessible land)
      #homerange size during rifle season (since more risky)
      #average movement rate during rifle 
      #average distance to restricted land
      #lived and died by age
# 4) Derive summary stats via summarize()

#####################################################################################
################################# 2014-2016 #########################################
#####################################################################################

phase1.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/SapphireElkProject_ElkDatabase.accdb")
#get mortality data
mort.dat1 <-sqlQuery(phase1.db, "SELECT * FROM MortalityInfo")
mort.dat1 <- mort.dat1 %>% 
  filter(Gender == "Male") %>% 
  rename(Animal.ID =`Animal ID`)%>% 
  dplyr::select(Animal.ID, MortDate, TransEndDate, Cause1, Cause2, MortOwnrshp, HarvestSeason) %>%
  mutate(Animal.ID = as.factor(Animal.ID)) %>%
  mutate(Date.mortality = as.Date(MortDate, format="%m/%d/%Y")) %>% 
  mutate(DateOff = as.Date(TransEndDate, format="%m/%d/%Y"))
head(mort.dat1)

#filter to harvest related morts, and standardize column names, and last clean
unique(mort.dat1$Cause1)
mort.dat1 <- mort.dat1 %>% 
  filter(Cause1 == "Harvest" | Cause1 == "Wounding loss") %>%
  rename(Harvest.season = HarvestSeason,
         Access = MortOwnrshp) %>% 
  mutate(Access = ifelse(Access == "Accessible", "Accessible", "Restricted" )) %>% 
  dplyr::select(Animal.ID, Date.mortality, Access, Harvest.season)

#get age  
animal.dat1 <- sqlQuery(phase1.db, "SELECT * FROM AnimalInfo")
animal.dat1 <- animal.dat1 %>%
  filter(Sex == "Male") %>% 
  rename(Animal.ID = AnimalID) %>% 
  mutate(Capture.date = as.Date(Date, format = "%m/%d/%Y"),
         Animal.ID = as.factor(Animal.ID)) %>% 
  dplyr::select(Animal.ID, Capture.date, Age)

#combine mortality and animal data
dat.1 <- left_join(mort.dat1, animal.dat1, by=c("Animal.ID" = "Animal.ID"))

#get age at mort
dat.1 <- dat.1 %>% 
  mutate(Mort.age = as.numeric(difftime(Date.mortality, Capture.date, tz = "GMT", units = "days"))) %>% 
  mutate(Mort.age = Mort.age/365 + Age,
         Fate = "Dead") %>% 
  dplyr::select(Animal.ID, Access, Fate, Harvest.season, Mort.age)


#####################################################################################
################################# 2018-2021 #########################################
#####################################################################################

ns.db <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};
                            dbq= C:/Users/pm132031/Documents/UM/SAPPHIRE_PROJECT/DATA/DB/NSERP2/NSERP2.accdb")
#animal data
animal.dat2 <- sqlQuery(ns.db, "SELECT * FROM AnimalInfo")
animal.dat2 <- animal.dat2 %>%
  rename(Animal.ID = AnimalID) %>% 
  mutate(Animal.ID = as.factor(Animal.ID),
         Capture.date = as.Date(CaptureDate, format="%m/%d/%Y"),
         Sex = ifelse(Sex == "M", "Male",
                      ifelse(Sex == "F", "Female", NA)),
         Age = ifelse(!is.na(ToothAge), ToothAge, EstAge)) %>% 
  filter(Sex == "Male") %>%  
  dplyr::select(Animal.ID, Age, Capture.date)

#only keep first capture date because multiple for some animals to derive avg age later 
animal.dat2 <- animal.dat2 %>% 
  group_by(Animal.ID) %>% 
  arrange(Capture.date) %>% 
  slice(1) %>% 
  ungroup()
  
#mortality data
mort.dat2 <-sqlQuery(ns.db, "SELECT * FROM Mortalities")
mort.dat2 <- mort.dat2 %>% 
  rename(Animal.ID = AnimalID,
         Access = Ownership,
         Mort.cause = MortCause) %>%
  filter(Mort.cause == "Harvest" | Mort.cause == "Poaching/Wounding loss" | Mort.cause == "Wounding loss") %>% 
  mutate(Animal.ID=as.factor(Animal.ID),
         Sex = ifelse(Sex == "M", "Male",
                      ifelse(Sex == "F", "Female", NA)),
         Access = ifelse(Access == "Public", "Accessible",
                         ifelse(Access == "Private", "Restricted", "Unknown")), 
         Date.mortality = as.Date(EstMortDate, format="%m/%d/%Y"),
         Harvest.season = ifelse(Date.mortality >= "2019-09-07" & Date.mortality <= "2019-10-20","Archery",
                                 ifelse(Date.mortality >= "2020-09-05" & Date.mortality <= "2020-10-18","Archery",
                                        ifelse(Date.mortality >= "2019-10-26" & Date.mortality <= "2019-12-01","Rifle",
                                               ifelse(Date.mortality >= "2020-10-24" & Date.mortality <= "2020-11-29","Rifle", "Other"))))) %>% 
  filter(Sex == "Male") %>% 
  dplyr::select(Animal.ID, Date.mortality, Access, Harvest.season) #no snow depth since NSERP didn't record

#combine mortality and animal data
dat.2 <- left_join(mort.dat2, animal.dat2, by=c("Animal.ID" = "Animal.ID"))

#get age at mort
dat.2 <- dat.2 %>% 
  mutate(Mort.age = as.numeric(difftime(Date.mortality, Capture.date, tz = "GMT", units = "days"))) %>% 
  mutate(Mort.age = Mort.age/365 + Age,
         Fate = "Dead") %>% 
  dplyr::select(Animal.ID, Access, Fate, Harvest.season, Mort.age)

#
#COMBINE MORT DATA FROM PHASE 1 AND 2
#

mort.dat.male <- rbind(dat.1,dat.2) %>% 
  rename(Mort.access = Access)

#write
saveRDS(mort.dat.male, file = "output\\Bull_Vulnerability\\mort_dat_male.rds")


#####################################################################################
######### GET DATE OFF FROM COLLAR DATA #############################################
#####################################################################################

#phase 1, use last location as end of monitoring because don't have Date off column
loc.dat1 <- sqlQuery(phase1.db, "SELECT * FROM LocationsProcessed")
loc.dat1 <- loc.dat1 %>%
  group_by(AnimalID) %>% 
  mutate(Date = as.Date(Date),
         Date.off = max(Date),
         Animal.ID = as.factor(AnimalID)) %>% 
  slice(1:1) %>% 
  filter(Sex == "Male") %>%
  ungroup() %>% 
  dplyr::select(Animal.ID, Date.off) %>% 
  na.omit() %>% 
  #fix date off for 151220
  mutate(across(Date.off, replace, Date.off == "2015-10-01", "2019-12-28")) 

#phase 2
collar.dat2 <- sqlQuery(ns.db, "SELECT * FROM CollarInfo")
collar.dat2 <- collar.dat2 %>%
  dplyr::select(AnimalID, CollarID, DateDeployed, DateOff, Sex) %>%
  mutate(Animal.ID = as.factor(AnimalID)) %>%
  mutate(Date.off = as.Date(DateOff, format="%m/%d/%Y")) %>% 
  filter(Sex == "M") %>% 
  dplyr::select(Animal.ID, Date.off) %>% 
  na.omit()

#remove duplicates from recapture, keep only most recent date
collar.dat2 <- collar.dat2 %>% 
  group_by(Animal.ID) %>% 
  arrange(desc(Date.off)) %>% 
  slice(1) %>% 
  ungroup()

date.off.dat <- rbind(loc.dat1, collar.dat2) %>% 
  distinct() %>% 
  as.data.frame()

#close database
odbcCloseAll()

#####################################################################################
######### GET AGE OF LIVING MALES, ADD PROPORTION COVER AND ACCESS USED #############
#####################################################################################

#
#AGE FOR LIVING MALES = AGE HALF WAY THROUGH MONITORING
#

#take only first row when grouped by Animal.ID because >0 males captured in 2014-2016 and lived to 2018-2021 study
animal.dat.all <- rbind(animal.dat1, animal.dat2) %>% 
  group_by(Animal.ID) %>% 
  arrange(Capture.date) %>% 
  slice(1) %>% 
  ungroup()

#add date off to animal data
#Animal.ID = 151220, originally captured 2015, lasted into phase 2
animal.dat.all <- left_join(animal.dat.all, date.off.dat, by=c("Animal.ID" = "Animal.ID")) %>% 
  group_by(Animal.ID) %>% 
  arrange(Capture.date) %>% 
  slice(1) %>% 
  ungroup()

#check capture date < date off, remove collars that put on and off in samae day
animal.dat.all %>% 
  with(Capture.date<Date.off)
animal.dat.all <- animal.dat.all %>% 
filter(Capture.date != Date.off)

#check results
animal.dat.all %>% 
  with(Capture.date<Date.off)

#average age for animals that lived
data.full <- left_join(animal.dat.all, data, by=c("Animal.ID" = "Animal.ID")) %>% 
  group_by(Animal.ID) %>% 
  mutate(Days.monitored.live = as.numeric(difftime(max(Date), Capture.date, tz = "GMT", units = "days")), 
         Age.days = Age*365,
         Avg.age = (Age.days + Days.monitored.live)/365) %>%
  ungroup() %>% 
  rename(Age.at.capture = Age) %>% 
  dplyr::select(!c(Days.monitored.live, Age.days))

#join data with mortality data  
data.full <- full_join(data.full,mort.dat.male, by=c("Animal.ID" = "Animal.ID")) %>% 
  mutate(Fate = ifelse(is.na(Fate), "Live","Dead")) 
data.full <- distinct(data.full)    

#
#PROPORTIONS USED VERSUS COVER AND ACCESS
#

#create column for proportion cover used over 35% (derived from chapter 2 threshold of security for males on accessible land during rifle) and access
data.full <- data.full %>% 
  mutate(Cover.35 = ifelse(Cover >= 35, 1, 0)) %>% 
  group_by(Animal.ID) %>% 
  filter(!is.na(Cover.35)) %>% 
  mutate(Prop.cover.35 = sum(Cover.35 == 1)/n(),
         Access.binary = ifelse(Access == "Accessible", 1, 0),
         Prop.access = sum(Access.binary == 1)/n()) %>% 
  ungroup()
summary(data.full)

#
#MOVEMENT RATE (from Jesse DeVoe's code)
#

# set projections
latlong <- "+proj=longlat +datum=WGS84"
mtstateplane <- "+init=EPSG:32100"

#create date time column and arrange
yo.sf <- st_as_sf(data.full) %>% 
  #dplyr::select(Animal.ID, Date, Time, geometry) %>% 
  #create datetime column from scratch due to package formatting
  mutate(Date = as.character(Date),
         Time = as.character(Time),
         Datetime = as.POSIXct(paste(Date,Time), format = "%Y-%m-%d %H:%M", tz = "GMT")) %>% 
  arrange(Animal.ID, Datetime) %>% 
  distinct()

#look for duplicates (MORE THAN 0!)
sum(duplicated(paste(yo.sf$Datetime, yo.sf$Animal.ID))) 
duplicated(paste(yo.sf$Datetime, yo.sf$Animal.ID))

#remove duplicates
yo.sf <- yo.sf %>% 
  group_by(Animal.ID) %>% 
  arrange(Datetime) %>%
  filter(duplicated(Datetime) == FALSE) %>% 
  ungroup()
  
#plot
mapview(yo.sf)
plot(yo.sf$geometry, 
     col = as.factor(yo.sf$Animal.ID), 
     pch = 16)

#calculate trajectories by animal
yo.sp <- as_Spatial(yo.sf %>% st_transform(mtstateplane)) 
traj <- adehabitatLT::as.ltraj(xy = coordinates(yo.sp), date = yo.sp$Datetime, id = yo.sp$Animal.ID)

traj.df <- do.call(rbind.data.frame, traj) %>%
  # get only dist (step length) and time difference, and turn to rate
  dplyr::select(dist, dt) %>%
  mutate(hrs = dt/3600, # Hours calc'd from dt (time interval in seconds, thus divided by 3600)
         rate = dist/hrs) # distance in meters per hour
head(traj.df)

#add column of average movement rate during rifle because risk highest during this season
data.full <- bind_cols(yo.sf, traj.df) 
#create movement rate for rifle season and rejoin, but limited data, so use avg movement rate for both archery and rifle
move.rates <- data.full %>%
  dplyr::select(Animal.ID, Hunt.season, dt, rate) %>% 
  st_set_geometry(NULL) %>% 
  na.omit() %>% #remove rows where rate = NA (very few)
  arrange(Animal.ID) %>%
  group_by(Animal.ID) %>%
  mutate(Mean.movement.rate = mean(rate)) %>% 
  slice(1) %>% #make easier to view
  ungroup() %>% 
  dplyr::select(Animal.ID, Mean.movement.rate)

data.full <- left_join(data.full, move.rates, by = "Animal.ID") %>% 
  dplyr::select(!c(Access, Season, Cover.35, dist, dt, hrs, rate)) %>% 
  rename(Access = Access.binary)

#write
saveRDS(data.full, file = "output\\Bull_Vulnerability\\data_full.rds")


#####################################################################################
######### EXPLORATORY SUMMARY STATS #################################################
#####################################################################################

#
#STATS OF AGES FOR DEAD VS LIVE
#

#age dat
age.dat <- data.full %>% 
  group_by(Animal.ID) %>% 
  slice(1) %>% 
  ungroup() %>% 
  as.data.frame() %>% 
  dplyr::select(Animal.ID,Age.at.capture,Fate) %>% 
  na.omit()

#plot
avg.age <- age.dat %>% 
  group_by(Fate) %>% 
  summarise(Avg.age = mean(Age.at.capture))
age.plot <- ggplot(age.dat, aes(x=Age.at.capture, color = Fate)) + 
  geom_histogram(position="identity")
age.plot + geom_vline(data=avg.age, aes(xintercept=Avg.age, color=Fate))

#mort by access
data.full %>% 
  filter(Fate == "Dead") %>% 
  group_by(Animal.ID) %>% 
  slice(1) %>% 
  ungroup() %>% 
  as.data.frame() %>% 
  dplyr::select(Animal.ID,Mort.access, Mort.age) %>% 
  na.omit() %>% 
  group_by(Mort.access) %>% 
  summarise(avg.age = mean(Mort.age))

#
#COVER, COVER.35, DIST.MR, VRM
#

yo <- data.full %>% 
  group_by(Animal.ID) %>%
  mutate(mean.cover = mean(Cover),
         prop.cover.35 = mean(Prop.cover.35),
         mean.dist.mr = median(Dist.MR),
         mean.vrm = mean(VRM)) %>% 
  slice(1) %>%
  dplyr::select(Animal.ID, Fate, prop.cover.35, Prop.access, Mean.movement.rate, mean.cover, mean.dist.mr, mean.vrm) %>% 
  na.omit() %>% 
  ungroup() %>% 
  group_by(Fate) %>%
  summarise(N = n(),
            Mean.cover = mean(mean.cover),
            Mean.proportion.cover.35 = mean(prop.cover.35),
            Mean.distance.MR = mean(mean.dist.mr),
            Mean.ruggedness = mean(mean.vrm)*100,
            Proportion.accessible = mean(Prop.access),
            Movement.rate = mean(Mean.movement.rate)) %>% 
  ungroup() %>% 
  st_set_geometry(NULL)%>% 
  mutate_if(is.numeric, round, digits = 2)

write.csv(yo, file = "output\\Bull_Vulnerability\\Tables\\Summary_Stats_Without_Age.csv", row.names = FALSE, append = TRUE)

#with age of individuals
yo2 <- data.full %>% 
  group_by(Animal.ID) %>% #grouping means less bias from animals with many points
  mutate(mean.cover = mean(Cover),
         prop.cover.35 = mean(Prop.cover.35),
         mean.dist.mr = mean(Dist.MR),
         mean.vrm = mean(VRM)) %>% 
  slice(1) %>%
  dplyr::select(Animal.ID, Fate, Age.at.capture, prop.cover.35, Prop.access, Mean.movement.rate, mean.cover, mean.dist.mr, mean.vrm) %>% 
  na.omit() %>% 
  ungroup() %>% 
  group_by(Fate) %>%
  summarise(N = n(),
            Mean.age = mean(Age.at.capture),
            Mean.cover = mean(mean.cover),
            Mean.proportion.cover.35 = mean(prop.cover.35),
            Mean.distance.MR = mean(mean.dist.mr),
            Mean.ruggedness = mean(mean.vrm)*100,
            Proportion.accessible = mean(Prop.access),
            Movement.rate = mean(Mean.movement.rate)) %>% 
  ungroup()%>% 
  st_set_geometry(NULL) %>% 
  mutate_if(is.numeric, round, digits = 2)

write.csv(yo2, file = "output\\Bull_Vulnerability\\Tables\\Summary_Stats_With_Age.csv", row.names = FALSE, append = TRUE)

#check n

#####################################################################################
######### BIND, CLEAN, AND ADD SPATIAL LAYERS #######################################
#####################################################################################











